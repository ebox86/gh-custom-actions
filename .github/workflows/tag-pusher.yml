name: Auto-update floating version tag

on:
  # Runs whenever you publish a GitHub Release
  release:
    types: [published]

jobs:
  update-floating-tag:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # needed to push updated tag

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # need tags + history

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Move floating major tag
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
        run: |
          echo "Release tag from event: $TAG_NAME"

          # Only handle tags that look like vMAJOR.MINOR.PATCH
          if ! echo "$TAG_NAME" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Tag '$TAG_NAME' does not match vMAJOR.MINOR.PATCH. Skipping floating tag update."
            exit 0
          fi

          # Extract MAJOR from vMAJOR.MINOR.PATCH
          MAJOR=$(echo "$TAG_NAME" | sed -E 's/^v([0-9]+).*/\1/')
          FLOATING="v$MAJOR"

          echo "Computed floating tag: $FLOATING (from $TAG_NAME)"

          # Ensure the target tag exists locally
          if ! git rev-parse "refs/tags/$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME not found locally. Fetching from origin..."
            git fetch origin "refs/tags/$TAG_NAME:refs/tags/$TAG_NAME" || {
              echo "Could not fetch tag $TAG_NAME from origin."
              exit 1
            }
          fi

          # Create or move the floating tag locally
          git tag -f "$FLOATING" "refs/tags/$TAG_NAME"

          # Push updated floating tag to origin
          echo "Pushing floating tag '$FLOATING' to origin (pointing at '$TAG_NAME')..."
          git push origin "refs/tags/$FLOATING" --force

          echo "Done. '$FLOATING' now points at '$TAG_NAME'."

